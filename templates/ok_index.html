<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chatbot</title>

<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-css.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>

<style>
body {
    font-family: Arial, sans-serif;
    background: #f4f4f4;
    padding: 20px;
    display: flex;
    justify-content: center;
    min-height: 100vh;
    margin: 0;
}

#chat-container {
    width: 90%;
    max-width: 900px;
    background: white;
    border-radius: 10px;
    display: flex;
    flex-direction: column;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

#chat {
    padding: 15px;
    max-height: 80vh;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
}

.message {
    margin: 8px 0;
    padding: 10px 14px;
    border-radius: 10px;
    max-width: 80%;
    word-wrap: break-word;
    line-height: 1.4;
}

.user {
    align-self: flex-end;
    background: #d0e7ff;
    color: #004080;
}

.assistant {
    align-self: flex-start;
    background: #e8e8e8;
    color: #333;
}

.codeblock {
    background: #f5f5f5;
    padding: 10px;
    border-left: 3px solid #007bff;
    border-radius: 5px;
    margin: 8px 0;
    position: relative;
    max-width: 90%;
    align-self: flex-start;
}

.codeblock pre {
    margin: 0;
    overflow-x: auto;
}

.codeblock code {
    font-family: 'Courier New', monospace;
    font-size: 14px;
}

.copy-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    background: #007bff;
    color: white;
    border: none;
    padding: 4px 8px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    z-index: 10;
}

.copy-btn:hover {
    background: #0056b3;
}

.copy-feedback {
    position: absolute;
    top: 5px;
    right: 70px;
    background: #28a745;
    color: white;
    border-radius: 3px;
    padding: 4px 8px;
    font-size: 12px;
    opacity: 0;
    transition: opacity 0.3s;
    z-index: 10;
}

.copy-feedback.show {
    opacity: 1;
}

#input-container {
    display: flex;
    padding: 10px;
    border-top: 1px solid #ddd;
}

textarea {
    flex: 1;
    padding: 10px;
    font-size: 16px;
    resize: vertical;
    min-height: 60px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

button {
    margin-left: 8px;
    padding: 10px 18px;
    font-size: 16px;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

button:hover {
    background-color: #0056b3;
}
</style>
</head>
<body>
<div id="chat-container">
    <div id="chat"></div>
    <div id="input-container">
        <textarea id="input" placeholder="Skriv..." rows="3"></textarea>
        <button id="send">Send</button>
    </div>
</div>

<script>
const chat = document.getElementById("chat");
const input = document.getElementById("input");
const send = document.getElementById("send");

// Escape HTML for text content
function escapeHtml(text) {
    return text.replace(/&/g, "&amp;")
               .replace(/</g, "&lt;")
               .replace(/>/g, "&gt;")
               .replace(/"/g, "&quot;")
               .replace(/'/g, "&#039;");
}

// Parse Markdown-style code blocks
function parseMessage(text) {
    const blocks = [];
    const parts = text.split('```');
    
    for (let i = 0; i < parts.length; i++) {
        if (i % 2 === 0) {
            // This is text (outside code blocks)
            const textContent = parts[i].trim();
            if (textContent) {
                blocks.push({type: 'text', content: textContent});
            }
        } else {
            // This is code (inside code blocks)
            // Split on first newline to separate language from code
            const firstNewlineIndex = parts[i].indexOf('\n');
            let language = '';
            let code = parts[i];
            
            if (firstNewlineIndex !== -1) {
                const potentialLang = parts[i].substring(0, firstNewlineIndex).trim();
                // Check if it looks like a language identifier
                // (short string with no spaces, common programming language names)
                if (potentialLang.length > 0 && 
                    potentialLang.length < 30 && 
                    !potentialLang.includes(' ') &&
                    !potentialLang.includes('<') &&
                    !potentialLang.includes('{')) {
                    language = potentialLang;
                    code = parts[i].substring(firstNewlineIndex + 1);
                }
            }
            
            // Trim code but preserve internal formatting
            code = code.replace(/^\n+/, '').replace(/\n+$/, '');
            
            if (code) {
                blocks.push({
                    type: 'code', 
                    language: language || 'plaintext', 
                    content: code
                });
            }
        }
    }

    // If no blocks were created, add entire text as single text block
    if (blocks.length === 0 && text.trim()) {
        blocks.push({type: 'text', content: text.trim()});
    }

    return blocks;
}

// Map common language aliases to Prism language classes
function getPrismLanguage(lang) {
    const languageMap = {
        'html': 'markup',
        'xml': 'markup',
        'js': 'javascript',
        'py': 'python',
        'python': 'python',
        'cpp': 'cpp',
        'c++': 'cpp',
        'c': 'c',
        'java': 'java',
        'css': 'css',
        'json': 'json',
        'bash': 'bash',
        'sh': 'bash',
        'shell': 'bash',
        'sql': 'sql',
        'plaintext': 'plaintext',
        'text': 'plaintext',
        '': 'plaintext'
    };
    return languageMap[lang.toLowerCase()] || 'plaintext';
}

// Append message with proper parsing
function appendMessage(role, text) {
    if (!text || text.trim() === '') return;
    
    const blocks = parseMessage(text);

    blocks.forEach((block, index) => {
        if (block.type === 'text') {
            const div = document.createElement('div');
            div.className = `message ${role}`;
            
            // Process markdown-style formatting in text
            let content = escapeHtml(block.content);
            
            // Convert markdown headings to HTML
            content = content.replace(/^### (.+)$/gm, '<strong>$1</strong>');
            content = content.replace(/^## (.+)$/gm, '<strong>$1</strong>');
            content = content.replace(/^# (.+)$/gm, '<strong style="font-size: 1.1em;">$1</strong>');
            
            // Convert line breaks
            content = content.replace(/\n/g, '<br>');
            
            div.innerHTML = content;
            chat.appendChild(div);
        } else if (block.type === 'code') {
            const wrapper = document.createElement('div');
            wrapper.className = 'codeblock';
            
            const pre = document.createElement('pre');
            const code = document.createElement('code');
            
            const prismLang = getPrismLanguage(block.language);
            code.className = `language-${prismLang}`;
            code.textContent = block.content;

            const copyBtn = document.createElement('button');
            copyBtn.className = 'copy-btn';
            copyBtn.textContent = 'KopiÃ©r';

            const feedback = document.createElement('div');
            feedback.className = 'copy-feedback';
            feedback.textContent = 'Kopieret!';

            copyBtn.addEventListener('click', () => {
                navigator.clipboard.writeText(block.content)
                    .then(() => {
                        feedback.classList.add('show');
                        setTimeout(() => feedback.classList.remove('show'), 2000);
                    })
                    .catch(err => {
                        console.error('Kunne ikke kopiere:', err);
                    });
            });

            pre.appendChild(code);
            wrapper.appendChild(feedback);
            wrapper.appendChild(copyBtn);
            wrapper.appendChild(pre);
            chat.appendChild(wrapper);

            // Highlight with Prism
            if (typeof Prism !== 'undefined') {
                Prism.highlightElement(code);
            }
        }
    });

    chat.scrollTop = chat.scrollHeight;
}

// Send message
async function sendMessage() {
    const msg = input.value.trim();
    if (!msg) return;

    appendMessage('user', msg);
    input.value = '';

    try {
        const res = await fetch('/chat', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({message: msg})
        });
        
        if (!res.ok) {
            throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        
        const data = await res.json();
        
        // Log raw response for debugging - show first 500 chars
        console.log('Raw response (first 500 chars):', data.response.substring(0, 500));
        console.log('Full response length:', data.response.length);
        
        // Parse and show blocks for debugging
        const parsedBlocks = parseMessage(data.response);
        console.log('Parsed blocks:', parsedBlocks.map(b => ({
            type: b.type, 
            language: b.language,
            contentPreview: b.content.substring(0, 50) + '...'
        })));
        
        appendMessage('assistant', data.response);
    } catch(err) {
        appendMessage('assistant', 'Fejl ved forbindelse til server: ' + err.message);
    }
}

send.onclick = sendMessage;
input.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

input.focus();
</script>
</body>
</html>
